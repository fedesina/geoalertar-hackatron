<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoAlertAR Demo - NASA Space Apps</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🔥</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 100vh; background: #333; }
        .leaflet-popup-content-wrapper { background: #f9fafb; }
        .info-panel { max-height: calc(100vh - 80px); }
    </style>
</head>
<body class="overflow-hidden">
    <div id="map"></div>

    <div class="absolute top-4 left-4 z-[1000] bg-white/80 backdrop-blur-sm p-4 rounded-lg shadow-lg max-w-sm info-panel overflow-y-auto">
        <h1 class="text-xl font-bold text-gray-800">GeoAlertAR Demo</h1>
        <p class="text-sm text-gray-600 mb-4">Riesgo de Incendios - Córdoba, AR</p>
        
        <div class="space-y-4">
            <div>
                <h3 class="font-semibold text-gray-700 mb-2 border-b pb-1">Niveles de Riesgo</h3>
                <div id="risk-filters" class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm pt-2">
                    </div>
            </div>
            <div>
                <h3 class="font-semibold text-gray-700 mb-2 border-b pb-1">Capas de Contexto</h3>
                <div id="layer-controls" class="space-y-1 text-sm pt-2">
                    </div>
            </div>
        </div>
    </div>

<script>
    // --- CONFIGURACIÓN ---
    const CSV_URL = 'riesgo_cordoba.csv';
    const MAP_CENTER = [-31.5, -64.2];
    const MAP_ZOOM = 7;
    const RISK_LEVELS = {
        "CRÍTICO": { color: "#ef4444" }, "ALTO": { color: "#f97316" },
        "MODERADO": { color: "#facc15" }, "BAJO": { color: "#22c55e" },
        "DATOS INSUFICENTES": { color: "#9ca3af" }
    };
    const LAYERS_CATALOG = [
        { name: 'Áreas Protegidas', file: 'layers/Areas_Protegidas_Poligono.geojson', style: { color: "#16a34a", weight: 2, opacity: 0.8, fillOpacity: 0.15 } },
        { name: 'Cuarteles de Bomberos', file: 'layers/Cuartel_Bomberos_Punto.geojson' }
    ];

    // --- INICIALIZACIÓN DEL MAPA ---
    const map = L.map('map').setView(MAP_CENTER, MAP_ZOOM);
    const nasaGibsLayer = L.tileLayer(
        'https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_CorrectedReflectance_TrueColor/default/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg',
        { attribution: '© NASA GIBS', maxZoom: 9 }
    ).addTo(map);

    const riskLayers = {}; // para guardar las capas de riesgo
    const contextLayers = {}; // para guardar las capas de contexto

    // --- LÓGICA PRINCIPAL ---
    document.addEventListener('DOMContentLoaded', () => {
        const papaScript = document.createElement('script');
        papaScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js';
        papaScript.onload = () => {
            loadRiskData(); // Cargar puntos de riesgo
            loadContextLayers(); // Cargar capas de contexto
        };
        document.head.appendChild(papaScript);
    });

    async function loadRiskData() {
        try {
            const response = await fetch(CSV_URL);
            if (!response.ok) throw new Error(`No se pudo cargar ${CSV_URL}`);
            const text = await response.text();
            const data = Papa.parse(text, { header: true }).data.filter(p => p.lat && p.lon);

            const filtersContainer = document.getElementById('risk-filters');
            
            for (const level in RISK_LEVELS) {
                const pointsInLevel = data.filter(p => p.nivel === level);
                if (pointsInLevel.length === 0) continue;

                const layerGroup = L.layerGroup();
                pointsInLevel.forEach(point => {
                    const config = RISK_LEVELS[level];
                    const tempDisplay = parseFloat(point.lst_celsius) > 0 ? `${point.lst_celsius}°C` : 'N/A';
                    
                    L.circleMarker([point.lat, point.lon], {
                        radius: 6, fillColor: config.color, color: "#1f2937",
                        weight: 1, opacity: 1, fillOpacity: 0.8
                    }).bindPopup(`
                        <div class="space-y-1 text-sm">
                            <h3 class="text-base font-bold">${point.nombre}</h3>
                            <p class="font-semibold" style="color:${config.color};">${point.nivel} (${point.riesgo_final}%)</p><hr>
                            <p><strong>NDVI:</strong> ${point.ndvi} | <strong>NBR:</strong> ${point.nbr}</p>
                            <p><strong>Temp. Sup.:</strong> ${tempDisplay}</p>
                            <p><strong>Precip (60d):</strong> ${point.precip_60d_mm} mm</p>
                        </div>
                    `).addTo(layerGroup);
                });
                
                riskLayers[level] = layerGroup.addTo(map);
                
                filtersContainer.innerHTML += `
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" checked onchange="toggleLayer(this, 'risk', '${level}')" class="h-4 w-4 rounded accent-[${RISK_LEVELS[level].color}]">
                        <span class="text-gray-700">${level}</span>
                    </label>`;
            }
        } catch (error) {
            console.error("Error al cargar los datos de riesgo:", error);
            // Opcional: mostrar un mensaje de error al usuario
        }
    }

    async function loadContextLayers() {
        const controlsContainer = document.getElementById('layer-controls');
        for (const layerInfo of LAYERS_CATALOG) {
            try {
                const response = await fetch(layerInfo.file);
                if (!response.ok) throw new Error(`No se pudo cargar ${layerInfo.file}`);
                const geojsonData = await response.json();
                
                const layer = L.geoJSON(geojsonData, {
                    style: layerInfo.style,
                    pointToLayer: (feature, latlng) => L.marker(latlng, { 
                        icon: L.divIcon({ html: '🚒', className: 'text-2xl', iconSize: [24, 24] }) 
                    })
                });
                contextLayers[layerInfo.name] = layer; // No se añade al mapa por defecto

                controlsContainer.innerHTML += `
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" onchange="toggleLayer(this, 'context', '${layerInfo.name}')" class="h-4 w-4 rounded">
                        <span class="text-gray-700">${layerInfo.name}</span>
                    </label>`;
            } catch (error) {
                console.error(`Error al cargar la capa ${layerInfo.name}:`, error);
                controlsContainer.innerHTML += `<p class="text-xs text-red-600">No se pudo cargar: ${layerInfo.name}</p>`;
            }
        }
    }

    function toggleLayer(checkbox, type, layerName) {
        const layer = (type === 'risk') ? riskLayers[layerName] : contextLayers[layerName];
        if (layer) {
            if (checkbox.checked) {
                map.addLayer(layer);
            } else {
                map.removeLayer(layer);
            }
        }
    }
</script>
</body>
</html>